name: Release Build

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的标签时触发,如 v1.0.0
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write  # 需要写权限来创建 release

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: amd64
            extension: .exe
          - os: windows-latest
            platform: windows
            arch: arm64
            extension: .exe
          - os: macos-latest
            platform: darwin
            arch: arm64
            extension: ''

    runs-on: ${{ matrix.os }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.7'
          cache: true

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: 安装 Wails CLI (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          go install github.com/wailsapp/wails/v3/cmd/wails3@latest
          echo "$env:USERPROFILE\go\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 安装 NSIS (Windows)
        if: matrix.platform == 'windows'
        run: |
          choco install nsis -y --no-progress
          echo "C:\Program Files (x86)\NSIS" >> $GITHUB_PATH
        shell: bash

      - name: 验证 NSIS 安装 (Windows)
        if: matrix.platform == 'windows'
        run: makensis -VERSION
        shell: bash

      - name: 安装 Wails CLI (macOS)
        if: matrix.platform == 'darwin'
        run: |
          go install github.com/wailsapp/wails/v3/cmd/wails3@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: 安装依赖 (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          # 安装前端依赖
          if (Test-Path frontend/package.json) {
            cd frontend
            pnpm install
            cd ..
          }
          # 下载 Go 模块
          go mod download

      - name: 安装依赖 (macOS)
        if: matrix.platform == 'darwin'
        run: |
          # 安装前端依赖
          if [ -f frontend/package.json ]; then
            cd frontend
            pnpm install
            cd ..
          fi
          # 下载 Go 模块
          go mod download

      - name: 构建应用 (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          # 确保使用 Windows 路径格式
          MSYS_NO_PATHCONV: 1
        run: |
          # 获取版本信息
          $VERSION = "${{ github.ref_name }}"
          if ([string]::IsNullOrEmpty($VERSION) -or $VERSION -eq "refs/heads/main") {
            $VERSION = "dev-$(git rev-parse --short HEAD)"
          }
          $BUILD_TIME = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $GIT_COMMIT = git rev-parse --short HEAD
          $GIT_BRANCH = git rev-parse --abbrev-ref HEAD

          Write-Host "版本信息: Version=$VERSION, BuildTime=$BUILD_TIME, Commit=$GIT_COMMIT, Branch=$GIT_BRANCH"

          # 通过环境变量传递版本信息给 Taskfile
          $env:APP_VERSION = $VERSION
          $env:BUILD_TIME = $BUILD_TIME
          $env:GIT_COMMIT = $GIT_COMMIT
          $env:GIT_BRANCH = $GIT_BRANCH
          wails3 package

      - name: 构建应用 (macOS)
        if: matrix.platform == 'darwin'
        run: |
          # 获取版本信息
          VERSION="${{ github.ref_name }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "refs/heads/main" ]; then
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GIT_COMMIT=$(git rev-parse --short HEAD)
          GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

          echo "版本信息: Version=$VERSION, BuildTime=$BUILD_TIME, Commit=$GIT_COMMIT, Branch=$GIT_BRANCH"

          # 通过环境变量传递版本信息给 Taskfile
          export APP_VERSION=$VERSION
          export BUILD_TIME=$BUILD_TIME
          export GIT_COMMIT=$GIT_COMMIT
          export GIT_BRANCH=$GIT_BRANCH
          wails3 package

      - name: 打包构建产物 (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          $arch = "${{ matrix.arch }}"
          # 符合 go-github-selfupdate 的命名规范
          $outputName = "mimi-${version}-windows-${arch}"

          # 创建发布目录
          New-Item -ItemType Directory -Force -Path release

          # 优先查找 NSIS 安装程序
          if (Test-Path "bin/mimi-${arch}-installer.exe") {
            Copy-Item "bin/mimi-${arch}-installer.exe" -Destination "release/${outputName}-installer.exe"
            Write-Host "✅ 找到 NSIS 安装程序: bin/mimi-${arch}-installer.exe"
          }

          # 打包可执行文件为 zip 用于自动更新 (go-github-selfupdate 支持解压)
          if (Test-Path "bin/mimi.exe") {
            Compress-Archive -Path "bin/mimi.exe" -DestinationPath "release/${outputName}.zip" -Force
            Write-Host "✅ 找到可执行文件: bin/mimi.exe"
          } elseif (Test-Path "build/bin/mimi.exe") {
            Compress-Archive -Path "build/bin/mimi.exe" -DestinationPath "release/${outputName}.zip" -Force
            Write-Host "✅ 找到可执行文件: build/bin/mimi.exe"
          } else {
            Write-Error "❌ 找不到构建产物"
            Write-Host "查找 bin/ 目录:"
            Get-ChildItem -Path bin -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
            Write-Host "查找 build/bin/ 目录:"
            Get-ChildItem -Path build/bin -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }

      - name: 打包构建产物 (macOS)
        if: matrix.platform == 'darwin'
        run: |
          version="${{ github.ref_name }}"
          # 符合 go-github-selfupdate 的命名规范
          outputName="mimi-${version}-darwin-${{ matrix.arch }}"

          # 创建发布目录
          mkdir -p release

          # 查找构建产物
          if [ -f "bin/mimi.app/Contents/MacOS/mimi" ]; then
            # 打包 .app 用于分发
            cd bin
            tar -czf "../release/${outputName}.app.tar.gz" mimi.app
            cd ..
            # 打包可执行文件为 tar.gz 用于自动更新 (go-github-selfupdate 支持解压)
            tar -czf "release/${outputName}.tar.gz" -C "bin/mimi.app/Contents/MacOS" mimi
            echo "✅ 找到 .app 包: bin/mimi.app"
          elif [ -f "build/bin/mimi.app/Contents/MacOS/mimi" ]; then
            # 打包 .app 用于分发
            cd build/bin
            tar -czf "../../release/${outputName}.app.tar.gz" mimi.app
            cd ../..
            # 打包可执行文件为 tar.gz 用于自动更新
            tar -czf "release/${outputName}.tar.gz" -C "build/bin/mimi.app/Contents/MacOS" mimi
            echo "✅ 找到 .app 包: build/bin/mimi.app"
          elif [ -f "bin/mimi" ]; then
            tar -czf "release/${outputName}.tar.gz" -C "bin" mimi
            echo "✅ 找到可执行文件: bin/mimi"
          elif [ -f "build/bin/mimi" ]; then
            tar -czf "release/${outputName}.tar.gz" -C "build/bin" mimi
            echo "✅ 找到可执行文件: build/bin/mimi"
          else
            echo "❌ 找不到构建产物"
            echo "查找 bin/ 目录:"
            ls -R bin/ 2>/dev/null || echo "bin/ 不存在"
            echo "查找 build/bin/ 目录:"
            ls -R build/bin/ 2>/dev/null || echo "build/bin/ 不存在"
            exit 1
          fi

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: mimi-${{ matrix.platform }}-${{ matrix.arch }}
          path: release/*
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: 显示下载的文件
        run: |
          ls -R artifacts/

      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/mimi-windows-amd64/*
            artifacts/mimi-windows-arm64/*
            artifacts/mimi-darwin-arm64/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 清理旧的 artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            mimi-windows-amd64
            mimi-windows-arm64
            mimi-darwin-arm64
